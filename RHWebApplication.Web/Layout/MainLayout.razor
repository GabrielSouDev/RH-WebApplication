@inject CustomAuthStateProvider AuthStateProvider
@inject NavigationManager NavigationManager
@inherits LayoutComponentBase

<MudThemeProvider Theme="@currentTheme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider /> 
     <MudLayout>
            <MudAppBar Class="d-flex align-items-center" Color="Color.Primary" Fixed="true" Elevation="25">
            <MudIconButton Disabled="@_notLogged" Icon="@arrowMenu" Color="Color.Inherit" Class="white-icon" OnClick="DrawerToggle" />
                <MudText Typo="Typo.h4">RH APPLICATION</MudText>
                <MudSpacer />
        <MudText Class="dropend" Typo="Typo.h6">@userName</MudText>
        <MudButton Disabled="@_notLogged" OnClick="LogoutAsync" Color="Color.Warning">Logout</MudButton>
            </MudAppBar>
    <MudDrawer Class="menu-section" Open="@_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="25">
                <NavMenu></NavMenu>
            </MudDrawer>
            <MudMainContent Class="menu-content">
                @Body
            </MudMainContent>
      </MudLayout>
@code {
    bool _drawerOpen;
    bool _notLogged;
    string arrowMenu = Icons.Material.Filled.KeyboardDoubleArrowLeft;
    string? userName = string.Empty;

    private MudTheme currentTheme = new MudTheme()
        {
            PaletteLight = RHApplicationPalette.CreatePallete
        };

    protected override async Task OnParametersSetAsync()
    {
        userName = string.Empty;
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        Console.WriteLine(user.Identity.IsAuthenticated);
        Console.WriteLine(user.Identity.Name);
        if(user.Identity.IsAuthenticated)
            userName = user.Identity.Name;

        _notLogged = false;
        _drawerOpen = true;
        arrowMenu = Icons.Material.Filled.KeyboardDoubleArrowRight;
        if (userName is null)
        {
            arrowMenu = Icons.Material.Filled.KeyboardDoubleArrowLeft;
            _notLogged = true;
            _drawerOpen = false;
        }
    }

    async Task LogoutAsync()
    {
        _notLogged = true;
        await AuthStateProvider.Logout();
        NavigationManager.NavigateTo("/Login");
    }
    void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
        arrowMenu = _drawerOpen ? Icons.Material.Filled.KeyboardDoubleArrowLeft : Icons.Material.Filled.KeyboardDoubleArrowRight;
    }
}